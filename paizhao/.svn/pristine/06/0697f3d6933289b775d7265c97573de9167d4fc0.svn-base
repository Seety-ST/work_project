<?php
/**
* @Desc:     咨询      
* @User:     wlq<wulq@yueus.com>
* @Date:     2016年10月12日
* @Time:     上午9:49:21
* @Version:  
*/
class pai_paizhao_consult_class extends POCO_TDG
{
    public function __construct()
    {
        $this->setServerId(101);
        $this->setDBName('mall_paizhao_db');
    }

    private function set_mall_consult_status_tbl()
    {
        $this->setTableName('mall_consult_status_tbl');
    }

    private function set_mall_consult_tbl()
    {
        $this->setTableName('mall_consult_tbl');
    }
    
    private function set_mall_consult_button_tbl()
    {
        $this->setTableName('mall_consult_button_tbl');
    }

    public function add_consult($data)
    {
        if (!$this->check_data($data, 'consult')) return array('result'=>-1, 'message'=>'data wrong!');
        $time = time();
        $data = array(
            'name' => $data['name'],
            'mobile' => $data['mobile'],
            'seller_id' => $data['seller_id'],
            'photographers' => $data['photographers'],
            'package_info' => $data['package_info'],
            'goods_id' => $data['goods_id'],
            'seller_id' => $data['seller_id'],
            'source' => $data['source'],
            'create_time' => $time,
            'update_time' => $time,
            'group_time' => strtotime('now'),
        );
        $this->set_mall_consult_tbl();
        $result = $this->insert($data);
        return $result ? array('result'=>1, 'message'=>'添加咨询成功') : array('result'=>-1, 'message'=>'添加失败');
    }

    public function edit_consult($edit_info)
    {

    }

    /**
     * 获取列表
     * @param string $where
     * @param string $limit
     */
    public function get_list($where = '', $limit = '0,40')
    {
        $this->set_mall_consult_tbl();
        return $this->findAll($where, $limit, '`id` DESC');
    }
    
    /**
     * 获取列表count值
     * @param string $where
     */
    public function get_list_count($where = '')
    {
        $this->set_mall_consult_tbl();
        return $this->findCount($where);
    }
    
    public function get_consult_status()
    {
        $status = POCO::getCache('paizhao_consult_status');
        if (!$status)
        {
            $this->set_mall_consult_status_tbl();
            $status = $this->findAll();
            POCO::setCache('paizhao_consult_status', $status);
        }
        return $status;
    }
    
    /**
     * 更改咨询信息
     * @param array $data
     * @param int $id
     */
    public function update_consult($data, $id)
    {
        $this->set_mall_consult_tbl();
        $id = (int)$id;
        return $this->update($data, "id={$id}");
    }
    
    /**
     * 获取咨询按钮的统计值
     * @param string $button_where
     * @param string $where
     * @param string $limit
     */
    public function get_consult_button_list($button_where = '' , $where = '', $limit = '0,40')
    {
        $this->set_mall_consult_button_tbl();
        $sql = "SELECT 
                    price,create_time,goods_name,goods_type_id,goods_style_id,photographers,consult_click_num,source,consult_num
                FROM
                    {$this->_db_name}.{$this->_tbl_name}
                LEFT JOIN
                   (SELECT 
                        goods_id,photographers,price,count(*) as consult_num, group_time
                    FROM
                        {$this->_db_name}.mall_consult_tbl
                    WHERE 
                        {$where}
                    GROUP BY `goods_id`, `group_time`) consult_tbl
                ON
                    {$this->_tbl_name}.goods_id = consult_tbl.goods_id AND {$this->_tbl_name}.`group_time` = consult_tbl.`group_time`
                WHERE
                    {$button_where}
                GROUP BY 
                    {$this->_tbl_name}.`goods_id`, {$this->_tbl_name}.`group_time`
                ORDER BY
                    `id` DESC
                LIMIT
                    {$limit}
                ";
        return $this->query($sql);   
    }
    
    /**
     * 获取统计值
     * @param string $where
     */
    public function get_consult_button_list_count($where = '')
    {
        $this->set_mall_consult_button_tbl();
        return $this->findCount($where);
    }
    
    /**
     * 添加咨询按钮的统计值
     * @param array $data
     */
    public function add_consult_button($data)
    {
        if (!$this->check_data($data, 'button')) return array('result'=>-1, 'message'=>'button data wrong!');
        $time = time();
        $data = array(
            (int)$data['goods_id'],
            (int)$data['seller_id'],
            '"' . mysql_escape_string($data['goods_name']) . '"',
            (int)$data['goods_type_id'],
            (int)$data['goods_style_id'],
            1,
            '"' . mysql_escape_string($data['source']) . '"',
            $time,
            $time,
            strtotime('now'),
        );
        $values = '(' . implode(',', $data) . ')';
        $this->set_mall_consult_button_tbl();
        $sql = "INSERT INTO 
                    {$this->_db_name}.{$this->_tbl_name}
                    (`goods_id`,`seller_id`,`goods_name`,`goods_type_id`,`goods_style_id`,`consult_click_num`,`source`,`create_time`,`update_time`,`group_time`)
                VALUES
                    {$values}
                ON DUPLICATE KEY UPDATE 
                    `count`=`count`+1, `update_time`=VALUES(`update_time`)
                ";
        return $this->query($sql);
    }
    
    /**
     * 验证数据
     * @param array $data
     * @param string $type
     * @return boolean
     */
    private function check_data($data, $type = 'consult')
    {
        $check = false;
        switch ($type)
        {
            case 'consult':
                if ($data['name'] && $data['mobile'] && $data['photographers'] && $data['package_info'] && $data['seller_id'] && $data['goods_id'] && $data['source'])
                {
                    $check = true;
                }
                break;
            case 'button':
                if ($data['goods_id'] && $data['goods_name'] && $data['goods_type_id'] && $data['goods_style_id'] && $data['source'])
                {
                    $check = true;
                }
                break;
        }
        return $check;
    }
}