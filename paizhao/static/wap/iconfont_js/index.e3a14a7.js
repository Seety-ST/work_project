"use strict";function uniqList(e){for(var s,t=[],n={},i=0,a=e.length;a>i;i++)s=e[i],s&&!n[s]&&(n[s]=1,t.push(s));return t}function getIconMatches(e,s,t){var n=e.match(s);if(n)for(var i=0;i<n.length;i++)n[i]=n[i].replace(t,"");return n||[]}var path=require("path"),fs=require("fs"),_=fis.util,icon=require("./iconfont.js"),iconfontTag=new RegExp("<!--ICONFONT_PLACEHOLDER-->"),fisVersion=fis.version.split(".")[0],isFis3=3===fisVersion,DEF_CONF={libs:["zepto","common","qqapi"],classPrefix:"i-",svgPath:"../svgs",output:"fonts/iconfont",cssInline:!1,pseClass:"before",base64:!1,pagePath:!1,checkAll:!0};module.exports=function(e,s,t,n){{var i=e.src;e.map.res}t=_.assign({},DEF_CONF,t);var a=fis.project.getProjectPath(),o=t.classPrefix||"i-",r=new RegExp("icon-font\\s"+o+"([a-zA-Z0-9\\-_]*)","mg"),c=new RegExp("icon-font\\s"+o,"g"),f=t.svgPath?path.join(a,t.svgPath):"";t._svgPath=f,fs.existsSync(f)||fis.log.error("目录 --"+f+'-- 不存在, 请配置正确的 fis-postpackager-iconfont 插件的 "svgPath" 属性');var l,g,p=t.ignore||["zepto","badjs","mod","bj-report","tools","db"],h=new RegExp(a+t.pagePath),u=[],v=[],d=[];_.map(i,function(e,s){if(l=_.ext(s.toString()),g=s.getContent(),s.isHtmlLike||".tpl"===l.ext)v=getIconMatches(g,r,c),v.length>0&&(d=d.concat(v)),(l.dirname===a||h.test(l.dirname))&&u.push(s);else if(s.isJsLike&&~~p.indexOf(l.filename)){var t=g.match(/addClass\([\'\"]([^\'\"\s]*\s)?i-([^\'\"\s]*)/gm);t&&(t.forEach(function(e,s){t[s]=t[s].replace(/addClass\([\'\"]([^\'\"\s]*\s)?i-/,"")}),d=d.concat(t))}}),d=uniqList(d),isFis3&&fis.emit("iconfont:allIcons",d);var m=icon.genarateFonts(t,d),C=m.content;if(!t.base64){t._fontCdn={};for(var P in C)if(C.hasOwnProperty(P)){var x=fis.file(a,m.subpath+"."+P);x.setContent(C[P]),isFis3||"dev"!==n.dest||(x.useHash=!1),e.pkg[x.subpath]=x,t._fontCdn[P]=x.getUrl(x.useHash,x.useDomain)}}var b;b=t.base64?icon.generateBase64Css(t,d,C.ttf):icon.generateCss(t,d);var E="font.css";E=path.join(t.output,E);var F=fis.file(a,E);F.setContent(b),isFis3||"dev"!==n.dest||(F.useHash=!1),e.pkg[F.subpath]=F;var k='<link rel="stylesheet" type="text/css" href="'+F.getUrl(F.useHash,F.useDomain)+'" />\r\n';t.cssInline&&(k="<style>\r\n"+b+"\r\n</style>"),u.forEach(function(e){var s=e.getContent();iconfontTag.test(s)?(s=s.replace(iconfontTag,k),t.checkAll||e.setContent(s)):s=s.replace("</head>","	"+k+"$&"),t.checkAll&&e.setContent(s)})};